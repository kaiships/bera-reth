# Runs hive RPC compatibility tests for bera-reth
# Runs every 6 hours and compares results to reth:nightly

name: hive-rpc

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

env:
  CARGO_TERM_COLOR: always

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  prepare-hive:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4

      - name: Checkout hive tests
        uses: actions/checkout@v4
        with:
          repository: berachain/hive
          ref: master
          path: hivetests

      - uses: actions/setup-go@v5
        with:
          go-version: "^1.21"
      - run: go version

      - name: Create hive assets directory
        run: mkdir -p hive_assets/

      - name: Build hive binary and simulators
        run: |
          cd hivetests
          go build .
          
          # Build RPC compatibility simulator images
          echo "Building RPC compatibility simulator"
          ./hive --sim "ethereum/rpc-compat" --sim.timelimit 1s || true

      - name: Save hive assets
        run: |
          cd hivetests
          # Save hive binary
          mv ./hive ../hive_assets/
          
          # Save simulator images
          docker save hive/simulators/ethereum/rpc-compat:latest -o ../hive_assets/rpc_compat.tar
          docker save hive/hiveproxy:latest -o ../hive_assets/hiveproxy.tar

      - name: Upload hive assets
        uses: actions/upload-artifact@v4
        with:
          name: hive-assets
          path: ./hive_assets/

  test-bera-reth:
    needs: [ prepare-hive ]
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - name: Download hive assets
        uses: actions/download-artifact@v4
        with:
          name: hive-assets
          path: /tmp/hive

      - name: Load Docker images
        run: |
          # Load hive images
          docker load -i /tmp/hive/rpc_compat.tar
          docker load -i /tmp/hive/hiveproxy.tar

      - name: Set up hive binary
        run: |
          mv /tmp/hive/hive /usr/local/bin/hive
          chmod +x /usr/local/bin/hive

      - name: Checkout hive tests
        uses: actions/checkout@v4
        with:
          repository: berachain/hive
          ref: master
          path: hivetests

      # bera-reth client config is already in berachain/hive fork
      # No need to copy configuration

      - name: Run RPC compatibility tests for bera-reth
        run: |
          cd hivetests
          echo "Running RPC compatibility tests for bera-reth"
          # Hive will automatically pull ghcr.io/berachain/bera-reth:nightly
          hive --sim ethereum/rpc-compat --client bera-reth
        continue-on-error: true

      - name: Save bera-reth test results
        run: |
          mkdir -p /tmp/results
          cp -r hivetests/workspace/logs /tmp/results/bera-reth-logs

      - name: Upload bera-reth results
        uses: actions/upload-artifact@v4
        with:
          name: bera-reth-results
          path: /tmp/results/bera-reth-logs

  test-reth-nightly:
    needs: [ prepare-hive ]
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - name: Download hive assets
        uses: actions/download-artifact@v4
        with:
          name: hive-assets
          path: /tmp/hive

      - name: Load Docker images
        run: |
          # Load hive images
          docker load -i /tmp/hive/rpc_compat.tar
          docker load -i /tmp/hive/hiveproxy.tar

      - name: Set up hive binary
        run: |
          mv /tmp/hive/hive /usr/local/bin/hive
          chmod +x /usr/local/bin/hive

      - name: Checkout hive tests
        uses: actions/checkout@v4
        with:
          repository: berachain/hive
          ref: master
          path: hivetests

      - name: Run RPC compatibility tests for reth
        run: |
          cd hivetests
          echo "Running RPC compatibility tests for reth:nightly"
          # Hive will automatically pull ghcr.io/paradigmxyz/reth:nightly
          hive --sim ethereum/rpc-compat --client reth
        continue-on-error: true

      - name: Save reth test results
        run: |
          mkdir -p /tmp/results
          cp -r hivetests/workspace/logs /tmp/results/reth-logs

      - name: Upload reth results
        uses: actions/upload-artifact@v4
        with:
          name: reth-results
          path: /tmp/results/reth-logs

  compare-results:
    needs: [ test-bera-reth, test-reth-nightly ]
    runs-on: ubuntu-latest
    if: always() && !cancelled()
    steps:
      - uses: actions/checkout@v4

      - name: Download bera-reth results
        uses: actions/download-artifact@v4
        with:
          name: bera-reth-results
          path: /tmp/bera-reth-results
        continue-on-error: true

      - name: Download reth results
        uses: actions/download-artifact@v4
        with:
          name: reth-results
          path: /tmp/reth-results
        continue-on-error: true

      - name: Generate comparison report
        run: |
          echo "## Hive RPC Compatibility Test Results" >> /tmp/report.md
          echo "" >> /tmp/report.md
          echo "**Run Date:** $(date -u)" >> /tmp/report.md
          echo "" >> /tmp/report.md
          
          # Check if both result sets exist
          BERA_RETH_JSON=$(find /tmp/bera-reth-results -name "*.json" ! -name "hive.json" 2>/dev/null | head -1)
          RETH_JSON=$(find /tmp/reth-results -name "*.json" ! -name "hive.json" 2>/dev/null | head -1)
          
          if [ -f "$BERA_RETH_JSON" ] && [ -f "$RETH_JSON" ]; then
            echo "### Test Summary" >> /tmp/report.md
            echo "" >> /tmp/report.md
          
            # Extract test counts and failed test lists from JSON files
              BERA_RETH_PASSED=$(jq '[.testCases[] | select(.summaryResult.pass == true)] | length' "$BERA_RETH_JSON")
              BERA_RETH_TOTAL=$(jq '.testCases | length' "$BERA_RETH_JSON")
              BERA_RETH_FAILED=$((BERA_RETH_TOTAL - BERA_RETH_PASSED))
          
              RETH_PASSED=$(jq '[.testCases[] | select(.summaryResult.pass == true)] | length' "$RETH_JSON")
              RETH_TOTAL=$(jq '.testCases | length' "$RETH_JSON")
              RETH_FAILED=$((RETH_TOTAL - RETH_PASSED))
          
              echo "| Client | Passed | Failed | Total |" >> /tmp/report.md
              echo "|--------|--------|--------|-------|" >> /tmp/report.md
              echo "| bera-reth | $BERA_RETH_PASSED | $BERA_RETH_FAILED | $BERA_RETH_TOTAL |" >> /tmp/report.md
              echo "| reth:nightly | $RETH_PASSED | $RETH_FAILED | $RETH_TOTAL |" >> /tmp/report.md
              echo "" >> /tmp/report.md
          
              # Extract lists of failed test names (strip client suffix)
              jq -r '.testCases[] | select(.summaryResult.pass == false) | .name' "$BERA_RETH_JSON" | sed 's/ (bera-reth)$//' | sort > /tmp/bera_reth_failed.txt
              jq -r '.testCases[] | select(.summaryResult.pass == false) | .name' "$RETH_JSON" | sed 's/ (reth)$//' | sort > /tmp/reth_failed.txt
              
              # Compare the lists of failed tests
              if cmp -s /tmp/bera_reth_failed.txt /tmp/reth_failed.txt; then
                echo "✅ **bera-reth fails the exact same tests as reth:nightly**" >> /tmp/report.md
                echo "COMPARISON_STATUS=success" >> $GITHUB_ENV
              else
                echo "❌ **bera-reth fails different tests than reth:nightly**" >> /tmp/report.md
                echo "" >> /tmp/report.md
                
                # Show which tests fail only in bera-reth
                BERA_ONLY=$(comm -23 /tmp/bera_reth_failed.txt /tmp/reth_failed.txt)
                if [ -n "$BERA_ONLY" ]; then
                  echo "**Tests failing only in bera-reth:**" >> /tmp/report.md
                  echo '```' >> /tmp/report.md
                  echo "$BERA_ONLY" >> /tmp/report.md
                  echo '```' >> /tmp/report.md
                  echo "" >> /tmp/report.md
                fi
                
                # Show which tests fail only in reth
                RETH_ONLY=$(comm -13 /tmp/bera_reth_failed.txt /tmp/reth_failed.txt)
                if [ -n "$RETH_ONLY" ]; then
                  echo "**Tests failing only in reth:nightly:**" >> /tmp/report.md
                  echo '```' >> /tmp/report.md
                  echo "$RETH_ONLY" >> /tmp/report.md
                  echo '```' >> /tmp/report.md
                  echo "" >> /tmp/report.md
                fi
                
                echo "COMPARISON_STATUS=failure" >> $GITHUB_ENV
              fi
          else
            echo "❌ Test results missing - check job failures above" >> /tmp/report.md
          fi
          
          echo "" >> /tmp/report.md
          echo "### Artifacts" >> /tmp/report.md
          echo "- bera-reth test logs: Available as 'bera-reth-results' artifact" >> /tmp/report.md
          echo "- reth:nightly test logs: Available as 'reth-results' artifact" >> /tmp/report.md
          echo "" >> /tmp/report.md
          echo "### Workflow Run" >> /tmp/report.md
          echo "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> /tmp/report.md

      - name: Display comparison report
        run: |
          echo "=== HIVE RPC COMPATIBILITY COMPARISON ==="
          cat /tmp/report.md
          echo ""
          echo "=== LOCAL TESTING COMMANDS ==="
          echo "To test this locally, run these commands from your hive directory:"
          echo ""
          echo "# Test bera-reth:"
          echo "hive --sim ethereum/rpc-compat --client bera-reth"
          echo ""
          echo "# Test reth:nightly:"
          echo "hive --sim ethereum/rpc-compat --client reth"

      - name: Upload comparison report
        uses: actions/upload-artifact@v4
        with:
          name: comparison-report
          path: /tmp/report.md

      - name: Fail if bera-reth has different test failures than reth
        if: env.COMPARISON_STATUS == 'failure'
        run: |
          echo "❌ bera-reth fails different individual tests than reth:nightly"
          echo "This indicates a regression or behavioral difference that needs investigation"
          echo "Check the comparison report above for details on which specific tests differ"
          exit 1