# Runs hive RPC compatibility tests for bera-reth
# Runs every 12 hours and compares results to reth:nightly

name: hive-rpc

on:
  workflow_dispatch:
  schedule:
    # Run 5 hours after nightly builds (1 AM + 5 hours = 6 AM, 1 PM + 5 hours = 6 PM UTC)
    - cron: "0 6,18 * * *"

env:
  CARGO_TERM_COLOR: always

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

jobs:
  hive-rpc-comparison:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4

      - name: Checkout hive tests
        uses: actions/checkout@v4
        with:
          repository: berachain/hive
          ref: master
          path: hivetests

      - uses: actions/setup-go@v5
        with:
          go-version: "^1.21"

      - name: Build hive binary and simulators
        run: |
          cd hivetests
          go build .
          
          # Build RPC compatibility simulator images
          echo "Building RPC compatibility simulator"
          ./hive --sim "ethereum/rpc-compat" --sim.timelimit 1s || true

      - name: Run RPC compatibility tests for both clients
        run: |
          cd hivetests
          echo "Running RPC compatibility tests for bera-reth and reth:nightly"
          # Test both clients in a single run for direct comparison
          ./hive --sim ethereum/rpc-compat --client bera-reth,reth
        continue-on-error: true

      - name: Save test results
        run: |
          mkdir -p /tmp/results
          cp -r hivetests/workspace/logs /tmp/results/hive-logs

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: hive-results
          path: /tmp/results/hive-logs

      - name: Compare test results using standalone script
        run: |
          # Run our dedicated comparison script
          set +e  # Allow script to exit with non-zero (we handle it below)
          ./scripts/compare-hive-results.sh /tmp/results/hive-logs > /tmp/comparison_output.txt 2>&1
          COMPARISON_EXIT_CODE=$?
          set -e
          
          # Display the comparison output
          echo "=== HIVE RPC COMPATIBILITY COMPARISON ==="
          cat /tmp/comparison_output.txt
          
          # Create markdown report from script output
          echo "## Hive RPC Compatibility Test Results" > /tmp/report.md
          echo "" >> /tmp/report.md
          echo "**Run Date:** $(date -u)" >> /tmp/report.md
          echo "" >> /tmp/report.md
          echo '```' >> /tmp/report.md
          cat /tmp/comparison_output.txt >> /tmp/report.md
          echo '```' >> /tmp/report.md
          echo "" >> /tmp/report.md
          echo "### Artifacts" >> /tmp/report.md
          echo "- Combined test logs: Available as 'hive-results' artifact" >> /tmp/report.md
          echo "" >> /tmp/report.md
          echo "### Workflow Run" >> /tmp/report.md
          echo "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> /tmp/report.md
          
          # Set environment variable based on script exit code
          if [[ $COMPARISON_EXIT_CODE -eq 0 ]]; then
            echo "COMPARISON_STATUS=success" >> $GITHUB_ENV
          else
            echo "COMPARISON_STATUS=failure" >> $GITHUB_ENV
          fi

      - name: Upload comparison report
        uses: actions/upload-artifact@v4
        with:
          name: comparison-report
          path: /tmp/report.md

      - name: Create issue on regression
        if: env.COMPARISON_STATUS == 'failure'
        uses: actions/github-script@v6
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const workflowUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `fix: hive rpc regression detected - ${date}`,
              body: `## Hive RPC Compatibility Regression
            
            **Date:** ${date}
            **Workflow Run:** ${workflowUrl}
            
            ### Issue
            Automated hive tests detected that bera-reth fails different individual tests than reth:nightly. This indicates a regression or behavioral difference that needs investigation.
            
            ### Next Steps
            1. Review the [workflow run details](${workflowUrl}) for specific test differences
            2. Check which tests are failing only in bera-reth vs reth:nightly
            3. Investigate the root cause of the behavioral differences
            4. Fix the regression or update tests if the change is intentional
            
            ### Test Commands
            To reproduce locally:
            \`\`\`bash
            # Test both clients simultaneously:
            hive --sim ethereum/rpc-compat --client bera-reth,reth
            \`\`\`
            
            This issue was automatically created by the hive-rpc workflow.`,
              labels: ['hive', 'regression']
            });

      - name: Fail workflow on regression
        if: env.COMPARISON_STATUS == 'failure'
        run: |
          echo "‚ùå bera-reth fails different tests than reth:nightly"
          echo "GitHub issue created for tracking this regression"
          exit 1